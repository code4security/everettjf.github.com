---
layout: post
title: UITableViewCell自动高度计算优化总结
excerpt: "当聊天室内大量消息到来时，如何最大限度的减少Cell高度的计算次数"
date: 2015-11-11
tags: [iOS开发笔记]
comments: true
---

解决了这个UITableViewCell自动高度计算的问题，简单总结也分享给大家。

# 先看最终效果


# 背景

- 一个主播聊天室，大量观众能发送大量的消息，赠送一些道具也会导致产生大量的道具消息。这里假设消息很多的情况：`每秒5条消息到来`。
- 消息使用NSAttributedString实现，`消息中包含不同大小的图片和文字`。
- 消息到来后，`自动滚动到最后一条消息`。

# 要求
- 不能占用大量CPU。
- 在大量消息到来的情况下，界面不能卡顿。

# 模拟
现实环境下，是由服务器的长连接不断发送来的消息。这里使用后台线程模拟不断产生消息。

# 功能实现

## 消息存储
- 全局消息列表（存储最近500条消息，到达500条后直接删除最早的300条）
- 每新增一条消息，会导致

## 自动计算高度
使用一个不错的开源库
[UITableView-FDTemplateLayoutCell](https://github.com/forkingdog/UITableView-FDTemplateLayoutCell)

## 问题
这个开源库在数据较少时没有问题，但当数据（消息）不断增加时，会导致高度计算量大增。


# 使用estimated效果不好
估计高度，会减少很多高度的计算量，每当Cell需要显示的时候才会计算高度。但大量消息的到来会导致Cell抖动，看起来很不舒服。

因为新增Cell是先按照估计高度显示，如果实际所需高度与估计高度不同，会在Cell显示后，再有个调整高度的过程（会有个简单的动画效果。这个效果如果在新增一条消息时很不多，但如果大量消息很短的间隔到来，就会导致Cell跳动起来）

# 再一次减少高度计算

由于消息一旦产生就不会变化，可将计算后的Cell高度再一次缓存到消息中。




# 参考文章




